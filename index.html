<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Panel Basket — Simple (sin cuotas ni reloj)</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#5b6679;
    --ok:#0a7f44; --warn:#9a6b00; --no:#b72626; --border:#e6ebf2
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:16px 20px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0}
  h1{margin:0;font-size:18px}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"]{padding:10px 12px;border:1px solid #cfd7e3;border-radius:10px;min-width:160px;background:#fff}
  button{padding:10px 14px;border-radius:10px;border:1px solid #cfd7e3;background:#fff;cursor:pointer}
  button.primary{background:#1f6feb;color:#fff;border-color:#1f6feb}
  button:disabled{opacity:.6;cursor:not-allowed}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;text-align:left;border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:#fff}
  tr td:first-child, tr th:first-child{border-left:1px solid var(--border);border-top-left-radius:12px;border-bottom-left-radius:12px}
  tr td:last-child, tr th:last-child{border-right:1px solid var(--border);border-top-right-radius:12px;border-bottom-right-radius:12px}
  th{font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:#334155;background:#f3f6fb}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600}
  .ok{background:#e7f8ef;color:var(--ok);border:1px solid #bfead2}
  .warn{background:#fff5d9;color:var(--warn);border:1px solid #ffe7a3}
  .no{background:#ffe9e9;color:var(--no);border:1px solid #ffd3d3}
  .mini{font-size:12px;color:#334155}
  .history{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#1f2937}
</style>
</head>
<body>
<header><h1>Panel Basket — Simple (sin cuotas ni reloj)</h1></header>

<div class="wrap">
  <!-- Configurar partido -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>Equipo A</label>
        <input id="teamA" type="text" placeholder="Ej: España" />
      </div>
      <div class="col">
        <label>Equipo B</label>
        <input id="teamB" type="text" placeholder="Ej: Lituania" />
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button id="startBtn" class="primary">Iniciar partido</button>
      </div>
      <div class="col">
        <label>Marcador (A-B)</label>
        <div class="row">
          <input id="scoreInput" type="text" placeholder="Ej: 24-17" />
          <button id="addBtn">Añadir tick</button>
          <button id="resetBtn">Reset</button>
        </div>
      </div>
    </div>
    <div class="mini" id="statusMsg">Escribe los nombres y pulsa “Iniciar partido”.</div>
  </div>

  <!-- Historial -->
  <div class="card" style="margin-top:12px">
    <div class="row"><div class="col" style="flex:1">
      <label>Historial</label>
      <div id="historyBox" class="history">—</div>
    </div>
    <div class="col" style="min-width:260px">
      <label>Resumen rápido</label>
      <div id="quick" class="mini">T: — · Lead: — · Fase: — · Ritmo: — · Momentum: —</div>
    </div></div>
  </div>

  <!-- Tabla -->
  <div class="card" style="margin-top:12px">
    <table>
      <thead>
        <tr>
          <th>Partido</th>
          <th>Señal</th>
          <th>Conf.</th>
          <th>Motivo</th>
          <th>Lead / Total</th>
          <th>Fase</th>
          <th>Ritmo</th>
          <th>Momentum</th>
          <th>Δlead1</th>
          <th>Swaps</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="mini">Reglas conservadoras. Solo usa tu historial: sin cuotas y sin reloj.</div>
  </div>
</div>

<script>
/* ====== Núcleo: señal solo con historial ====== */
function signalFromScore(history) {
  if (!history || history.length === 0) return out('ESPERA','sin datos',0);
  const a = history.at(-1).a, b = history.at(-1).b;
  const T = a + b, lead = Math.abs(a - b), sign = Math.sign(a-b);
  const fase = (T < 70) ? 'early' : (T < 110 ? 'mid' : (T < 140 ? 'late' : 'verylate'));

  const deltasLead=[], deltasT=[];
  for (let i=1;i<history.length;i++){
    const p=history[i-1], c=history[i];
    deltasLead.push(Math.abs(c.a-c.b)-Math.abs(p.a-p.b));
    deltasT.push((c.a+c.b)-(p.a+p.b));
  }
  const lastDL = deltasLead.at(-1) ?? 0;
  const last5DT = deltasT.slice(-5);

  let momentum=0;
  if (history.length>=4){
    const then = Math.abs(history.at(-4).a - history.at(-4).b);
    momentum = lead - then;
  }

  const median = arr => {
    if (!arr.length) return 0;
    const s=[...arr].sort((x,y)=>x-y), m=Math.floor(s.length/2);
    return s.length%2 ? s[m] : (s[m-1]+s[m])/2;
  };
  const mDT=median(last5DT);
  const ritmo = (mDT >= 6) ? 'fast' : (mDT <= 3 ? 'slow' : 'medium');

  let swaps=0;
  for (let i=1;i<history.length;i++){
    const sp=Math.sign(history[i-1].a-history[i-1].b);
    const sn=Math.sign(history[i].a-history[i].b);
    if (sp!==0 && sn!==0 && sp!==sn) swaps++;
  }

  if (history.length<5) return out('ESPERA','historia corta (<5 ticks)',0,{T,lead,sign,fase,ritmo,momentum,lastDL,swaps});
  if (Math.abs(lastDL)>=5) return out('ESPERA','volatilidad alta (Δlead≥5)',0,{T,lead,sign,fase,ritmo,momentum,lastDL,swaps});
  if (swaps>=3) return out('NO','demasiados cambios de líder',0,{T,lead,sign,fase,ritmo,momentum,lastDL,swaps});

  const need =
    (fase==='mid') ? 14 :
    (fase==='late') ? (ritmo==='fast' ? 12 : 10) :
    (fase==='verylate') ? (ritmo==='fast' ? 11 : 9) : Infinity;

  if (fase==='early') return out('NO','fase temprana',0,{T,lead,sign,fase,ritmo,momentum,lastDL,swaps});

  let conf =
    (fase==='mid')      ? (65 + 1.0*(lead-14)) :
    (fase==='late')     ? (75 + 1.2*(lead-need)) :
    (fase==='verylate') ? (82 + 1.5*(lead-need)) : 0;

  if (momentum>=2) conf += 4;
  if (ritmo==='fast') conf -= 4;
  conf -= 6;
  if (Math.abs(lastDL)>=3) conf -= 3;
  conf = Math.max(0, Math.min(92, conf));

  if (lead>=need && conf>=82 && lastDL<=0) return out('ENTRA', why(), Math.round(conf), {T,lead,sign,fase,ritmo,momentum,lastDL,swaps});
  if (lead>=need && conf>=70)               return out('ESPERA', why(), Math.round(conf), {T,lead,sign,fase,ritmo,momentum,lastDL,swaps});
  return out('NO',     why(), Math.round(Math.min(conf,69)), {T,lead,sign,fase,ritmo,momentum,lastDL,swaps});

  function why(){ return `${fase}+${ritmo}, lead=${lead} (need≥${need}), momentum=${momentum}, Δlead1=${lastDL}`; }
  function out(signal, reason, confidence, debug){
    return { signal, reason, confidence, stake: signal==='ENTRA'?1.0:0, debug: debug||{} };
  }
}

/* ====== UI ====== */
const state = {
  teamA: '', teamB: '', history: []
};

const $ = s => document.querySelector(s);
const teamA = $('#teamA'), teamB = $('#teamB');
const startBtn = $('#startBtn'), addBtn = $('#addBtn'), resetBtn = $('#resetBtn');
const scoreInput = $('#scoreInput');
const statusMsg = $('#statusMsg'), historyBox = $('#historyBox'), tbody = $('#tbody'), quick = $('#quick');

startBtn.addEventListener('click', ()=>{
  state.teamA = (teamA.value||'Equipo A').trim();
  state.teamB = (teamB.value||'Equipo B').trim();
  statusMsg.textContent = `Partido iniciado: ${state.teamA} vs ${state.teamB}. Ahora añade ticks (ej: 24-17).`;
  addBtn.disabled = false;
  resetBtn.disabled = false;
  scoreInput.disabled = false;
  scoreInput.focus();
  render();
});

addBtn.addEventListener('click', addTick);
resetBtn.addEventListener('click', ()=>{
  state.history.length = 0;
  render();
});
scoreInput.addEventListener('keydown', e=>{ if(e.key==='Enter') addTick(); });

// desactivar hasta iniciar
addBtn.disabled = true; resetBtn.disabled = true; scoreInput.disabled = true;

function addTick(){
  const val = (scoreInput.value || '').trim();
  const m = /^(\d+)\s*-\s*(\d+)$/.exec(val);
  if(!m){ alert('Formato inválido. Usa A-B, ej: 72-58'); return; }
  const a = parseInt(m[1],10), b = parseInt(m[2],10);
  state.history.push({a,b});
  if(state.history.length>40) state.history.splice(0, state.history.length-40);
  scoreInput.value = '';
  render();
}

function pill(text, kind){
  const cls = kind==='ok'?'ok':kind==='warn'?'warn':'no';
  return `<span class="pill ${cls}">${text}</span>`;
}

function render(){
  historyBox.textContent = state.history.length ? state.history.map(h=>`${h.a}-${h.b}`).join('  →  ') : '—';
  const res = signalFromScore(state.history);
  const d = res.debug || {};
  if(state.history.length){
    quick.textContent = `T: ${d.T??'—'} · Lead: ${d.lead??'—'} · Fase: ${d.fase??'—'} · Ritmo: ${d.ritmo??'—'} · Momentum: ${d.momentum??'—'}`;
  } else {
    quick.textContent = 'T: — · Lead: — · Fase: — · Ritmo: — · Momentum: —';
  }
  const matchName = `${state.teamA || 'Equipo A'} vs ${state.teamB || 'Equipo B'}`;
  const signalType = res.signal==='ENTRA'?'ok':res.signal==='ESPERA'?'warn':'no';
  const leadTotal = state.history.length ? `${d.lead ?? '—'} / ${d.T ?? '—'}` : '—';
  tbody.innerHTML = `
    <tr>
      <td>${matchName}</td>
      <td>${pill(res.signal, signalType)}</td>
      <td>${res.confidence ?? 0}%</td>
      <td class="mini">${res.reason || '—'}</td>
      <td>${leadTotal}</td>
      <td>${d.fase ?? '—'}</td>
      <td>${d.ritmo ?? '—'}</td>
      <td>${d.momentum ?? '—'}</td>
      <td>${d.lastDL ?? '—'}</td>
      <td>${d.swaps ?? '—'}</td>
    </tr>`;
}
</script>
</body>
</html>
